#!/usr/bin/env bash
dbfile="nvd-api.db"

dump(){
	sqlite3 "$dbfile" "select * from cves_tracked"
}

remove_entry(){
	declare cve query
	cve="${1//\"/}"
	cve="\"$cve\""
	echo "removing $cve from cves_tracked"
	query="delete from cves_tracked WHERE cve_id= '$cve';"
	sqlite3 "$dbfile"  "$query"
}

cve_search(){
	declare cve query
	cve="${1//\"/}"
	cve="\"$cve\""
	query="select * from cves_tracked WHERE cve_id= '$cve';"
	sqlite3 "$dbfile" "$query"
}

cpe_search(){
	#search by specified cpe
	declare cpe query
	cpe="$1"
	query="select * from cves_tracked WHERE cpe= '$cpe';"
	sqlite3 "$dbfile" "$query"
}

program_search(){
	# search by product name without needing the cpe
	declare term query
	term="$1"
	query="select * from cves_tracked WHERE cpe LIKE '%$term%';"
	sqlite3 "$dbfile" "$query"
}

print_help(){
	echo "A few simple helper functions to query the local sqlite database of tracked cves (if in use, see cve_query.sh)"
	echo "to be expanded"
	echo "usage: db_manage.sh COMMAND TERM"
	echo 
	echo "commands: "
	echo "search_program PROGRAM "
	echo "search_cve CVE"
	echo "search_cpe CPE"
	echo
}

operation="$1"
search_term="$2"
case "$operation" in 
	search_program)	
		program_search "$search_term" ;;
	search_cve)
		cve_search "$search_term" ;;
	search_cpe)
		cpe_search "$search_term" ;;
	help) 
		print_help ;;
	*) 
		echo "unrecognized command $operation"
		print_help ;;
esac
